---
title: "Correlograms"
author: "Daniel Thurber"
date: "5/7/2021"
output: pdf_document
---
```{r}
mypath <- 'C:/Users/Daniel/Documents/Research/data/dataframes/'  #leave this as directory
library(ggplot2)
library(naniar)
sitecodes <- c('LR_FB_BA', 'LR_TG_BA', 'BC_CONF_A', 'TF_CONF_A','RHF_CONF_A',
               'RS_CONF_A', 'TF_SAWM_A', 'SPC_CONF_A', 'LR_WC_A', 'LR_GCB_A')
sitenames <- c('Franklin Basin', 'Tony Grove', 'Beaver Creek', 'Temple Fork', 'Right Hand Fork',
               'Ricks Spring', 'TF at Sawmill', 'Spawn Creek', 'Above Wood Camp', 'Guinavah Campground')
linecols <- c('brown3', 'goldenrod', 'forestgreen', 'bisque4', 'slateblue', 'sienna3', 'aquamarine3', 'magenta4')
rgbmat <- col2rgb(linecols)/255
```


Read LRO aquatic and SNOTEL .csv files and generate dataframes
---
```{r}
i <- 1
snofile <- 'TF_1013.csv'
#FB_484, GCS_1114, KN_1115, TF_1013, TGL_823, TGRS_1113, UDD_1098
site <- sitecodes[i]               #enter site code for file upload and export
sitename <- sitenames[i]        #enter site name for plotting
paste('Site:', sitecodes[i], '-', sitenames[i])
linecols <- c('brown3', 'goldenrod', 'forestgreen', 'bisque4', 'slateblue', 'sienna3', 'aquamarine3', 'magenta4')
#color vector gets used by other plotting scripts.  Attempt to maintain any changes made to the palette
```
### Use the following section to evaluate correlation to snotel data
---
Begin by running SNOTEL and LRO_aquatic scripts to generate the qtc and snodf dataframes as .csv files.  This chunk will re-open them.

```{r}
# reads in original QA/QC data without patches
#creates the qtc dataframe
qtc <- read.csv(paste0(mypath,site,'.csv'), stringsAsFactors = F)
snodf <- read.csv(paste0(mypath,snofile), stringsAsFactors = F)
qtc$date <- as.Date(qtc$date,'%Y-%m-%d')
snodf$Date = as.Date(snodf$Date, format = '%Y-%m-%d')
mindate <- qtc$date[1]
```

Generate ACF functions over the entire period of record

Calculate autocorrelation functions for each variable and compile in DF
```{r}
lagmax <- 360
Qacf <- acf(qtc$discharge, lag.max = lagmax, type = "correlation", plot = F, na.action = na.pass)
Tacf <- acf(qtc$temperature, lag.max = lagmax, type = "correlation", plot = F, na.action = na.pass)
Cacf <- acf(qtc$conductance, lag.max = lagmax, type = "correlation", plot = F, na.action = na.pass)

acfdf <- data.frame('lag' = Cacf$lag, 
                    'Qval' = c(Qacf$acf, rep(NA,times = lagmax+1-length(Qacf$acf))), #adds NA to missing values
                    'Tval' = Tacf$acf, 
                    'Cval' = Cacf$acf)

```

Plot autocorrelation functions for Q, EC, and T at a given site
```{r}
plot(acfdf$lag, acfdf$Qval, type = 'l', col='blue',
     ylab = 'Correlation', xlab = 'Lag', ylim = c(-1,1), main = paste('Autocorrelation functions for' ,sitename))
lines(acfdf$Tval, col = 'brown4')
lines(acfdf$Cval, col = 'green')
legend(155,1, legend = c('discharge', 'conductance', 'temperature'), 
       lty = 1, col = c('blue', 'green', 'brown4'))

```

Show the date range of the dataframe
```{r}
paste(min(qtc$WY), 'through', max(qtc$WY))
```

select a specific water year, display the lines with missing values 
```{r}
wateryear <- 2018
wydf <- qtc[which(qtc$WY==wateryear),]
paste('Missing discharge:')
which(is.na(wydf$discharge))
paste('Missing conductance:')
which(is.na(wydf$conductance))
nrow(wydf)
```
show discharge during selected interval
```{r}
plot(wydf$discharge[235:360], type = 'l')
```

Based on the missing values, identify an interval over which to evaluate the autocorrelation function
```{r}
lagmax <- 50  #this should be left at 50
Qstart <- 1   #first day of extended Q records
Qend <- 200  #last day of Q records
Cstart <- 1   #first day of extended SC records
Cend <- 279   #last day of SC records
wyQacf <- acf(wydf$discharge[Qstart:Qend], lag.max = lagmax, type = "correlation", plot = F, na.action = na.pass)
#wyTacf <- acf(wydf$temperature[Cstart:acfend], lag.max = lagmax, type = "correlation", plot = F, na.action = na.pass)
wyCacf <- acf(wydf$conductance[Cstart:Cend], lag.max = lagmax, type = "correlation", plot = F, na.action = na.pass)

wyacfdf <- data.frame('lag' = wyCacf$lag, 
                    'Qval' = wyQacf$acf, #adds NA to missing values
                     
                    'Cval' = wyCacf$acf)
qdates <- paste('Q:',format(wydf$date[Qstart], '%m/%d'), 'through' ,format(wydf$date[Qend], '%m/%d'))
cdates <- paste('C:',format(wydf$date[Cstart], '%m/%d'), 'through' ,format(wydf$date[Cend], '%m/%d'))
paste(qdates,'    ', cdates)
```

Create an ACF plot for the particular water year.  Add any relevant notes about the timeframe over which this was evaluated.  Text indicates number of days until loss of correlation (0.2 threshold)
```{r}
plot(wyacfdf$lag, wyacfdf$Qval, type = 'l', col='blue',
     ylab = 'Correlation', xlab = 'Lag', ylim = c(0,1),
     main = paste('Autocorrelation functions for' ,sitename, wateryear))
lines(wyacfdf$Cval, col = 'green')
legend('topright', legend = c('discharge', 'conductance'), 
       lty = 1, col = c('blue', 'green'))
abline(h = .2, lty = 4)
text(x = 40, y =0.7, labels = qdates)
#text(x = 40, y =0.7, labels = 'Discharge missing 1/06')
text(x = 40, y =0.6, labels = cdates)
text(x = 40, y = 0.5, labels = paste('Q:', which(wyacfdf$Qval<0.2)[1], 'days'))
text(x = 40, y = 0.4, labels = paste('SC:', which(wyacfdf$Cval<0.2)[1], 'days'))

```






### This section generates and plots CCF functions from SNOTEL data over the entire period of record
---
This chunk will compile the crossdf dataframe with columns for date, melt, rain, discharge, temp, and conductance
```{r}
crossdf <- data.frame(date = snodf$Date[which(snodf$Date==mindate):nrow(snodf)])
crossdf$melt = snodf$melt[which(snodf$Date==mindate):nrow(snodf)]
crossdf$rain = snodf$rain[which(snodf$Date==mindate):nrow(snodf)]
for (i in 1:nrow(qtc)){
  crossdf$discharge[which(crossdf$date == qtc$date[i])] = qtc$discharge[i]
}
for (i in 1:nrow(qtc)){
  crossdf$conductance[which(crossdf$date == qtc$date[i])] = qtc$conductance[i]
}
for (i in 1:nrow(qtc)){
  crossdf$temp[which(crossdf$date == qtc$date[i])] = qtc$temperature[i]
}
crossdf$SWI <- crossdf$melt+crossdf$rain
```

Generate CCF objects for each relationship we are interested in:
```{r}
c_by_m <- ccf(crossdf$conductance,crossdf$melt, lag.max = lagmax, plot = F, na.action = na.pass)
q_by_t <- ccf(crossdf$discharge,crossdf$temp, lag.max = lagmax, plot = F, na.action = na.pass)
q_by_c <- ccf(crossdf$discharge,crossdf$conductance, lag.max = lagmax, plot = F, na.action = na.pass)
q_by_m <- ccf(crossdf$discharge,crossdf$melt, lag.max = lagmax, plot = F, na.action = na.pass)
q_by_r <- ccf(crossdf$discharge,crossdf$rain, lag.max = lagmax, plot = F, na.action = na.pass)
q_by_swi <- ccf(crossdf$discharge,crossdf$SWI, lag.max = lagmax, plot = F, na.action = na.pass)
t_by_c <- ccf(crossdf$temp,crossdf$conductance, lag.max = lagmax, plot = F)
```

Create on plot of all calculated cross-correlations
```{r}
par( mar = c(5.1,4.1,4.1,8.1))
plot(c_by_m$acf~c_by_m$lag, xlab='lag (days)', ylab='correlation',
     col=linecols[1], type = 'l', ylim=c(-0.4,0.4), xlim = c(0,lagmax))
lines(q_by_t$acf, col=linecols[2])
lines(q_by_c$acf, col = linecols[3])
lines(q_by_m$acf, col = linecols[4])
lines(q_by_swi$acf, col = linecols[5])
lines(t_by_c$acf, col = linecols[6])
lines(q_by_r$acf, col = linecols[7])

par(xpd=T)
title(main = c("Cross-correlation function for",sitename))
legend('topright', col = linecols, lty = 1, inset = c(-.3,0),
       legend = c('ec | melt', 'Q | T', 'Q | ec', 'Q | melt', 'Q | SWI', 'T | ec', 'Q | rain'))
```
```{r}
corrhold <- 0.20
paste('Lag times for end of correlation at',sitename)
paste('Discharge:',acfdf$lag[which(acfdf$Qval<corrhold)[1]])
paste('Conductivity:',acfdf$lag[which(acfdf$Cval<corrhold)[1]])
paste('Q | melt peaks after', q_by_m$lag[which(q_by_m$acf==max(q_by_m$acf[362:462]))] ,
      'days at', max(q_by_m$acf[362:462]))
paste('SC | melt peaks after', c_by_m$lag[which(c_by_m$acf==min(c_by_m$acf[362:462]))] ,
      'days at', min(c_by_m$acf[362:462]))
paste('Q | SC peaks after', q_by_c$lag[which(q_by_c$acf==min(q_by_c$acf[362:462]))] ,
      'days at', min(q_by_c$acf[362:462]))
```
Run this chunk to explore correlation values and timing for Q | melt
```{r}
poslag <- which(q_by_m$lag>0)
poslag[1]
q_by_m$acf[362:462]
q_by_m$lag[which(abs(q_by_m$acf)>0.20)]

```
```{r}
poslag <- which(c_by_m$lag>0)
poslag[1]
c_by_m$acf[362:462]
c_by_m$lag[which(abs(c_by_m$acf)>0.20)]
```

```{r}
plot(c_by_m$acf~q_by_m$lag, type = 'l')
q_by_c$acf[362:462]
```

Plot multiple relevant/interesting correlograms together
```{r}
lagdays <- 80
plot(acfdf$lag, acfdf$Qval, type = 'l', col='cadetblue4',
     ylab = 'Correlation', xlab = 'Lag', ylim = c(0.2,1), xlim=c(0,lagdays),
     main = paste('Mixed correlation functions for' ,sitename))
lines(acfdf$Cval, col = 'palegreen4')
lines(q_by_m$acf, col = 'brown4')
lines(-1*c_by_m$acf, col = linecols[1] )
legend('topright', legend = c('Q acf', 'SC acf', 'Q | melt', 'C | melt'), 
       lty = 1, col = c('cadetblue4', 'palegreen4', 'brown4', linecols[1]))

```












### This section generates and plots CCF functions from UEB model results, comparing across water years
---

This chunk will read in the ***_mod.csv file 
```{r}
mypath <- 'C:/Users/Daniel/Documents/Research/data/dataframes/'  #leave this as directory

#sitenames- 1:Franklin Basin, 2:Tony Grove, 3:Beaver Creek, 4:Temple Fork, 5:Right Hand Fork, 
#6:Ricks Spring, 7:Sawmill, 8:Spawn, 9:Wood Camp, 10:Guinavah)

i <- 2

site <- sitecodes[i]               #enter site code for file upload and export
sitename <- sitenames[i]
crossdf <- read.csv(paste0('C:/Users/Daniel/Documents/Research/data/dataframes/',site,'_mod.csv'))

crossdf$date <- as.Date(crossdf$date,'%Y-%m-%d')
head(crossdf,3)
paste('Site:', site, '-',sitename)
```

Plot conductance and discharge with data holes highlighted with blue lines on a user-decided date
```{r}
date.mark <- '02-15' #vertical blue lines will be drawn at this date for reference (mm-dd format)

qholes <- which(is.na(crossdf$qpatch))
choles <- which(is.na(crossdf$cpatch))

plot(crossdf$cpatch, type = 'l', ylab = 'conductance', main = paste('Patched Conductance at', sitename))
abline(v = choles, col = 'red')
abline(v = which(format(crossdf$date,'%m-%d')==date.mark), col='goldenrod')

plot(crossdf$qpatch, type = 'l', ylab = 'discharge', main = paste('Patched discharge at', sitename))
abline(v = which(is.na(crossdf$discharge)), col = 'darkseagreen3')
abline(v = qholes, col = 'red')
#abline(v = which(format(crossdf$date,'%m-%d')==date.mark), col='goldenrod')

```

Select the complete study interval
```{r}
study.int <- c(230,1550)
a <- study.int[1]  #index of starting time
b <- study.int[2]   #index of ending time based on study interval


yrange <- c(0,max(crossdf$qpatch[study.int[1]:study.int[2]], na.rm = T))


plot(crossdf$qpatch, xlim = study.int, ylim = yrange, type = 'l', 
     ylab = 'discharge (cms)', xlab = 'date',
     main = paste('discharge at', sitename, crossdf$WY[a], '-', crossdf$WY[b-60]), xaxt = 'n'
     )
axis(1, at = seq(a,b, length.out = 6), labels = (crossdf$date[seq(a,b,length.out = 6)]))

abline(v = qholes, col = 'red')
```


```{r}
a <- study.int[1]  #index of starting time
b <- study.int[2]   #index of ending time based on study interval


win1 <- c(230,450)  #red rect for 2015
win2 <- c(620,820)  #yellow rect for 2016
win3 <- c(960,1175)  #green rect for 2017
win4 <- c(1350,1550)   #gray rect for 2019


#plot discharge over the window.  The line gets plotted later over the highlight rectangles
plot(crossdf$qpatch, xlim = c(a, b), ylim = yrange, type = 'n', ylab = 'discharge', 
     main = paste('discharge at', sitename,crossdf$WY[a], '-', crossdf$WY[b-40]), xaxt = 'n', xlab = 'date'
     )

#highlight ranges for each window of CCF analysis
rect(xleft=win1[1], xright=win1[2], ybottom = 0, ytop=yrange[2], border = NA,  
     col = rgb(rgbmat[1,1],rgbmat[2,1],rgbmat[3,1], alpha = 0.5))
rect(xleft=win2[1], xright=win2[2], ybottom = 0, ytop=yrange[2], border = NA,  
     col = rgb(rgbmat[1,2],rgbmat[2,2],rgbmat[3,2], alpha = 0.5))
rect(xleft=win3[1], xright=win3[2], ybottom = 0, ytop=yrange[2], border = NA,  
    col = rgb(rgbmat[1,3],rgbmat[2,3],rgbmat[3,3], alpha = 0.5))
rect(xleft=win4[1], xright=win4[2], ybottom = 0, ytop=yrange[2], border = NA,  
     col = rgb(rgbmat[1,4],rgbmat[2,4],rgbmat[3,4], alpha = 0.5))


lines(crossdf$qpatch, type = 'l')
axis(1, at = seq(a,b, length.out = 6), labels = (crossdf$date[seq(a,b,length.out = 6)]))

```




Name each window for the legend on the CCF plot, in order from bottom to top with the window highlight rectangles shown above 
```{r}
#automatically enters date ranges to the legend for each window
win.names <- c(paste(crossdf$WY[win1[1]]),
               paste(crossdf$WY[win2[1]]), 
               paste(crossdf$WY[win3[1]]),
               paste(crossdf$WY[win4[1]]),
               paste(crossdf$WY[win5[1]]))


#win.names <- c('3/5-8/12','4/4-10/11','4/4-8/12','3/5-10/11','4/4-11/10')
```


Compute CCF of Q | SWIT within each window.
```{r}
lagmax <- 200
ccf1 <- ccf(crossdf$qpatch[win1[1]:win1[2]], crossdf$SWIT[win1[1]:win1[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf2 <- ccf(crossdf$qpatch[win2[1]:win2[2]], crossdf$SWIT[win2[1]:win2[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf3 <- ccf(crossdf$qpatch[win3[1]:win3[2]], crossdf$SWIT[win3[1]:win3[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf4 <- ccf(crossdf$qpatch[win4[1]:win4[2]], crossdf$SWIT[win4[1]:win4[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)

```

```{r}
plot(ccf1$lag, ccf1$acf, col=linecols[1],
     ylab = 'Correlation', xlab = 'Lag (days)', ylim = c(-0.2,0.9), xlim = c(0,50), 
     main = paste('Q|SWIT Crosscorrelation by water year:', sitename),
     type = 'n', #change to 'n' to hide, 'l' to show
     )
#lines(ccf2$acf[(lagmax+2):(lagmax*2+1)], col = linecols[2],xlim = c(0,lagmax))
lines(ccf3$acf[(lagmax+2):(lagmax*2+1)], col = linecols[3],xlim = c(0,lagmax))
lines(ccf4$acf[(lagmax+2):(lagmax*2+1)], col = linecols[4])
#lines(ccf5$acf[(lagmax+2):(lagmax*2+1)], col = linecols[5])

abline(h = 0.2, lty = 3)
abline(h = -0.2, lty = 3)

legend('bottomleft', legend = win.names[3:4], lty = 1, col = linecols[3:4]) 
```
```{r}
paste("Days till peak:")
paste(win.names[1]  ,which(ccf1$acf==max(ccf1$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[2]  ,which(ccf2$acf==max(ccf2$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[3]  ,which(ccf3$acf==max(ccf3$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[4]  ,which(ccf4$acf==max(ccf4$acf[(lagmax+2):(lagmax+50)]))-201)

paste("days of correlation:")
paste(win.names[1]  ,which(abs(ccf1$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)
paste(win.names[2]  ,which(abs(ccf2$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)
paste(win.names[3]  ,which(abs(ccf3$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)
paste(win.names[4]  ,which(abs(ccf4$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)

```

Compute CCF of C | SWIT within each window.
```{r}
lagmax <- 200
ccf1 <- ccf(crossdf$cpatch[win1[1]:win1[2]], crossdf$SWIT[win1[1]:win1[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf2 <- ccf(crossdf$cpatch[win2[1]:win2[2]], crossdf$SWIT[win2[1]:win2[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf3 <- ccf(crossdf$cpatch[win3[1]:win3[2]], crossdf$SWIT[win3[1]:win3[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf4 <- ccf(crossdf$cpatch[win4[1]:win4[2]], crossdf$SWIT[win4[1]:win4[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf5 <- ccf(crossdf$cpatch[win5[1]:win5[2]], crossdf$SWIT[win5[1]:win5[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)

```

```{r}
plot(ccf1$lag, -ccf1$acf, col=linecols[1],
     ylab = 'Correlation (negative)', xlab = 'Lag (days)', ylim = c(-0.2,0.9), xlim = c(0,50), 
     main = paste('SC|SWIT Crosscorrelation by water year at', sitename),
          type = 'n', #change to 'n' to hide, 'l' to show
)
#lines(-ccf2$acf[(lagmax+2):(lagmax*2+1)], col = linecols[2],xlim = c(0,lagmax))
lines(-ccf3$acf[(lagmax+2):(lagmax*2+1)], col = linecols[3],xlim = c(0,lagmax))
lines(-ccf4$acf[(lagmax+2):(lagmax*2+1)], col = linecols[4])
#lines(-ccf5$acf[(lagmax+2):(lagmax*2+1)], col = linecols[5])

abline(h = 0.2, lty = 3)
abline(h = -0.2, lty = 3)

#edit the indices to chose which items appear in the legend
legend('bottomleft', legend = win.names[c(3,4)], lty = 1, col = linecols[c(3,4)]) 
```

```{r}
paste("Days till peak:")
paste(win.names[1]  ,which(ccf1$acf==min(ccf1$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[2]  ,which(ccf2$acf==min(ccf2$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[3]  ,which(ccf3$acf==min(ccf3$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[4]  ,which(ccf4$acf==min(ccf4$acf[(lagmax+2):(lagmax+50)]))-201)

paste("days of correlation:")
paste(win.names[1]  ,which(abs(ccf1$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)
paste(win.names[2]  ,which(abs(ccf2$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)
paste(win.names[3]  ,which(abs(ccf3$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)
paste(win.names[4]  ,which(abs(ccf4$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)

```


This section compares CCF functions from different catchments within a water year
---
This chunk will read in the ***_mod.csv file 
```{r}
correlations$Qswit_FB_15
```


```{r}

correlations <- read.csv(paste0('C:/Users/Daniel/Documents/Research/data/dataframes/correlations.csv'))

head(correlations,3)

```


```{r}
write.csv(mod.df, paste0('C:/Users/Daniel/Documents/Research/data/dataframes/correlations.csv'), row.names = F)
```
Plot conductance and discharge with data holes highlighted with blue lines on a user-decided date
```{r}
date.mark <- '02-15' #vertical blue lines will be drawn at this date for reference (mm-dd format)

qholes <- which(is.na(crossdf$qpatch))
choles <- which(is.na(crossdf$cpatch))

plot(crossdf$cpatch, type = 'l', ylab = 'conductance', main = paste('Patched Conductance at', sitename))
abline(v = choles, col = 'red')
abline(v = which(format(crossdf$date,'%m-%d')==date.mark), col='cadetblue')

plot(crossdf$qpatch, type = 'l', ylab = 'discharge', main = paste('Patched discharge at', sitename))
abline(v = which(is.na(crossdf$discharge)), col = 'darkseagreen3')
abline(v = qholes, col = 'red')
abline(v = which(format(crossdf$date,'%m-%d')==date.mark), col='cadetblue')

```


Select the complete study interval
```{r}
study.int <- c(230,1550)
a <- study.int[1]  #index of starting time
b <- study.int[2]   #index of ending time based on study interval


yrange <- c(0,max(crossdf$qpatch[study.int[1]:study.int[2]], na.rm = T))


plot(crossdf$qpatch, xlim = study.int, ylim = yrange, type = 'l', 
     ylab = 'discharge (cms)', xlab = 'date',
     main = paste('discharge at', sitename, crossdf$WY[a], '-', crossdf$WY[b-60]), xaxt = 'n'
     )
axis(1, at = seq(a,b, length.out = 6), labels = (crossdf$date[seq(a,b,length.out = 6)]))

abline(v = which(is.na(crossdf$discharge)), col = 'darkseagreen3')
abline(v = qholes, col = 'red')
```



```{r}
a <- study.int[1]  #index of starting time
b <- study.int[2]   #index of ending time based on study interval



win1 <- c(230,450)  #red rect for 2015
win2 <- c(620,820)  #yellow rect for 2016
win3 <- c(960,1175)  #green rect for 2017
win4 <- c(1350,1550)   #gray rect for 2019


#plot discharge over the window.  The line gets plotted later over the highlight rectangles
plot(crossdf$qpatch, xlim = c(a, b), ylim = yrange, type = 'n', ylab = 'discharge', 
     main = paste('discharge at', sitename,crossdf$WY[a], '-', crossdf$WY[b-40]), xaxt = 'n', xlab = 'date'
     )

#highlight ranges for each window of CCF analysis
#rect(xleft=win1[1], xright=win1[2], ybottom = 0, ytop=yrange[2], border = NA,  
#     col = rgb(rgbmat[1,1],rgbmat[2,1],rgbmat[3,1], alpha = 0.5))
#rect(xleft=win2[1], xright=win2[2], ybottom = 0, ytop=yrange[2], border = NA,  
#     col = rgb(rgbmat[1,2],rgbmat[2,2],rgbmat[3,2], alpha = 0.5))
rect(xleft=win3[1], xright=win3[2], ybottom = 0, ytop=yrange[2], border = NA,  
col = rgb(rgbmat[1,3],rgbmat[2,3],rgbmat[3,3], alpha = 0.5))
rect(xleft=win4[1], xright=win4[2], ybottom = 0, ytop=yrange[2], border = NA,  
     col = rgb(rgbmat[1,4],rgbmat[2,4],rgbmat[3,4], alpha = 0.5))
#rect(xleft=win5[1], xright=win5[2], ybottom = 0, ytop=yrange[2],  border = NA, 
#     col = rgb(rgbmat[1,5],rgbmat[2,5],rgbmat[3,5], alpha = 0.5))

#

lines(crossdf$qpatch, type = 'l')
axis(1, at = seq(a,b, length.out = 6), labels = (crossdf$date[seq(a,b,length.out = 6)]))

```




Name each window for the legend on the CCF plot, in order from bottom to top with the window highlight rectangles shown above 
```{r}
#automatically enters date ranges to the legend for each window
win.names <- c(paste(crossdf$WY[win1[1]]),
               paste(crossdf$WY[win2[1]]), 
               paste(crossdf$WY[win3[1]]),
               paste(crossdf$WY[win4[1]]),
               paste(crossdf$WY[win5[1]]))


#win.names <- c('3/5-8/12','4/4-10/11','4/4-8/12','3/5-10/11','4/4-11/10')
```




Compute CCF of Q | SWIT within each window.
```{r}
lagmax <- 200
ccf1 <- ccf(crossdf$qpatch[win1[1]:win1[2]], crossdf$SWIT[win1[1]:win1[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf2 <- ccf(crossdf$qpatch[win2[1]:win2[2]], crossdf$SWIT[win2[1]:win2[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf3 <- ccf(crossdf$qpatch[win3[1]:win3[2]], crossdf$SWIT[win3[1]:win3[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf4 <- ccf(crossdf$qpatch[win4[1]:win4[2]], crossdf$SWIT[win4[1]:win4[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf5 <- ccf(crossdf$qpatch[win5[1]:win5[2]], crossdf$SWIT[win5[1]:win5[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)

```

```{r}
plot(ccf1$lag, ccf1$acf, col=linecols[1],
     ylab = 'Correlation', xlab = 'Lag (days)', ylim = c(-0.2,0.9), xlim = c(0,50), 
     main = paste('Q|SWIT Crosscorrelation by water year:', sitename),
     type = 'n', #change to 'n' to hide, 'l' to show
     )
#lines(ccf2$acf[(lagmax+2):(lagmax*2+1)], col = linecols[2],xlim = c(0,lagmax))
lines(ccf3$acf[(lagmax+2):(lagmax*2+1)], col = linecols[3],xlim = c(0,lagmax))
lines(ccf4$acf[(lagmax+2):(lagmax*2+1)], col = linecols[4])
#lines(ccf5$acf[(lagmax+2):(lagmax*2+1)], col = linecols[5])

abline(h = 0.2, lty = 3)
abline(h = -0.2, lty = 3)

legend('bottomleft', legend = win.names[3:4], lty = 1, col = linecols[3:4]) 
```
```{r}
paste("Days till peak:")
paste(win.names[1]  ,which(ccf1$acf==max(ccf1$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[2]  ,which(ccf2$acf==max(ccf2$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[3]  ,which(ccf3$acf==max(ccf3$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[4]  ,which(ccf4$acf==max(ccf4$acf[(lagmax+2):(lagmax+50)]))-201)

paste("days of correlation:")
paste(win.names[1]  ,which(abs(ccf1$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)
paste(win.names[2]  ,which(abs(ccf2$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)
paste(win.names[3]  ,which(abs(ccf3$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)
paste(win.names[4]  ,which(abs(ccf4$acf[(lagmax+2):(lagmax+100)])<0.2)[1]-1)

```

Compute CCF of C | SWIT within each window.
```{r}
lagmax <- 200
ccf1 <- ccf(crossdf$cpatch[win1[1]:win1[2]], crossdf$SWIT[win1[1]:win1[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf2 <- ccf(crossdf$cpatch[win2[1]:win2[2]], crossdf$SWIT[win2[1]:win2[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf3 <- ccf(crossdf$cpatch[win3[1]:win3[2]], crossdf$SWIT[win3[1]:win3[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf4 <- ccf(crossdf$cpatch[win4[1]:win4[2]], crossdf$SWIT[win4[1]:win4[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)
ccf5 <- ccf(crossdf$cpatch[win5[1]:win5[2]], crossdf$SWIT[win5[1]:win5[2]], lag.max = lagmax, 
             plot = F, na.action = na.pass)

```

```{r}
plot(ccf1$lag, -ccf1$acf, col=linecols[1],
     ylab = 'Correlation (negative)', xlab = 'Lag (days)', ylim = c(-0.2,0.9), xlim = c(0,50), 
     main = paste('SC|SWIT Crosscorrelation by water year at', sitename),
          type = 'n', #change to 'n' to hide, 'l' to show
)
#lines(-ccf2$acf[(lagmax+2):(lagmax*2+1)], col = linecols[2],xlim = c(0,lagmax))
lines(-ccf3$acf[(lagmax+2):(lagmax*2+1)], col = linecols[3],xlim = c(0,lagmax))
lines(-ccf4$acf[(lagmax+2):(lagmax*2+1)], col = linecols[4])
#lines(-ccf5$acf[(lagmax+2):(lagmax*2+1)], col = linecols[5])

abline(h = 0.2, lty = 3)
abline(h = -0.2, lty = 3)

#edit the indices to chose which items appear in the legend
legend('bottomleft', legend = win.names[c(3,4)], lty = 1, col = linecols[c(3,4)]) 
```

```{r}
paste("Days till peak:")
paste(win.names[1]  ,which(ccf1$acf==min(ccf1$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[2]  ,which(ccf2$acf==min(ccf2$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[3]  ,which(ccf3$acf==min(ccf3$acf[(lagmax+2):(lagmax+50)]))-201)
paste(win.names[4]  ,which(ccf4$acf==min(ccf4$acf[(lagmax+2):(lagmax+50)]))-201)

paste("days of correlation:")
paste(win.names[1]  ,which(abs(ccf1$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)
paste(win.names[2]  ,which(abs(ccf2$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)
paste(win.names[3]  ,which(abs(ccf3$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)
paste(win.names[4]  ,which(abs(ccf4$acf[(lagmax+2):(lagmax+50)])<0.2)[1]-1)

```


---
