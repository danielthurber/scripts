---

title: "Thesis Figures"
author: "Daniel Thurber"
date: "6/9/2022"
output: pdf_document
---

### Inititialization
```{r}
mypath <- 'C:/Users/Daniel/Documents/Research/data/dataframes/'  #leave this as directory
library(naniar)
library(snotelr)
library(stringr)
library(zoo, warn.conflicts = F)
library(raster, warn.conflicts = F)

windowsFonts(A = windowsFont('Times New Roman'))

sitecodes <- c('LR_FB_BA', 'LR_TG_BA', 'BC_CONF_A', 'TF_CONF_A','RHF_CONF_A', 'RS_CONF_A', 
               'TF_SAWM_A', 'SPC_CONF_A', 'LR_WC_A', 'LR_GCB_A', 'WCS_CONF_A', 'LR_FD')
sitenames <- c('Franklin Basin', 'Tony Grove', 'Beaver Creek', 'Temple Fork', 'Right Hand Fork','Ricks Spring', 
               'TF at Sawmill', 'Spawn Creek', 'Above Wood Camp', 'Guinavah Campground','Wood Camp Spring','First Dam')
siteabbr <- c('FB', 'TG', 'BC', 'TF','RH', 'RS', 
              'TS', 'SC', 'WC', 'GC', 'WS','FD')

sitesnotel <- c(1115, 1115, 1114,1013,1013, 823, 
              1013, 1098, 1113, 1113, 823,1098)
ST.el <- c(7250, 7250, 7705,7406,7406, 8474, 
           7406, 8270, 6332, 6332, 8474,8270)*0.3048

#FB_484, GCS_1114, KN_1115, TF_1013, TGL_823, TGRS_1113, UDD_1098
#GCS: 7705, KN: 7250, TF: 7406, USUDD: 8270, TGRS: 6332, TGL: 8474, FB: 8140

startyear <- c(2015,2015,2016,2016,2017,2016,
               2019,2019,2019,2019,2019,2015)
all.years <- c(2015:2021)

acf.sites <- c('FB_', 'TG_', 'BC_', 'TF_', 'RH_', 'RS_', 'TS_', 'SC_', 'WC_', 'GC_', 'WS_', 'FD_')
acf.years <- c('15','16','17','18','19','20','21')
plot.points <- c(15,17,19,18,1,5,7)
year.type <- c('(Moderate)', '(Moderate)', '(Wet)', '(Dry)', '(Wet)', '(Moderate)', '(Dry)')

dayticks <- c(93,124,153, 184,214,245,275,306,337,366) #water year days corresponding to the first of the month
ticklabs <- c('Jan 1', 'Feb 1','Mar 1','Apr 1','May 1','Jun 1','Jul 1','Aug 1','Sep 1', 'Oct 1')
linecols <- c('red1', 'gold', 'forestgreen', 'bisque4', 'slateblue4', 'cyan', 
              'aquamarine3', 'magenta2', 'peru','green','yellow','dodgerblue1')
linetypes <- c(1,1,1,1,1,3,1,1,1,1,4,1)
rgbmat <- col2rgb(linecols)
wydates <- data.frame(wyday = seq(1,366),
day=format(seq.Date(as.Date('2019-10-1','%Y-%m-%d'),as.Date('2020-09-30','%Y-%m-%d'),1),'%m-%d'))
comp.df <- read.csv(paste0('C:/Users/Daniel/Documents/Research/data/dataframes/catchment_comparison.csv'))
corr.df <- read.csv('C:/Users/Daniel/Documents/Research/data/dataframes/correlograms.csv')
colnames(comp.df)[4:ncol(comp.df)] <- str_sub(colnames(comp.df)[4:ncol(comp.df)],-6,-1) #make sure column names are only the last 6 characters
row.names(comp.df) <- sitecodes
data.frame(A=row.names(comp.df),B=comp.df[,'site_name'])==data.frame(A=sitecodes, B = sitenames)#verify that row names match up
comp.vars <- data.frame('VAR' = c('KST', 'HYI', 'MDS','VAA','MHS', 'MDE'),
                        'ax.lab' = c('Karst Surface Extent (%)', 'Hypsometric Integral','Median Slope', 'Average Aspect', 'Median Hillshade', 'Median Elevation (m)'),
                        'main.lab' = c('Karst Area', 'Hypsometry', 'Slope', 'Aspect', 'Hillshade', 'Elevation'))
prior.vars <- data.frame('VAR'=c('TMP','QRM','BQS','MXS'),
                         'ax.lab' = c('Modeled Fall Precipitation (m)', 
                         'Minimum 7-day Average Preceeding Baseflow (mm/hr)',
                         'Days of Baseflow Q|SWIT Correlation',
                         'Maximum SWE (m)'),
                         'main.lab' = c('Fall Precipitation','Preceeding Baseflow','Baseflow Correlation','Maximum SWE'))
head(comp.df[,which(colSums(comp.df[,4:ncol(comp.df)],na.rm = T)!=0)+3],5)
```
Initialize catchment areas in km^2
```{r}
site.areas <- c(65.9767, #FB
                277.965, #TG
                103.4015, #BC
                41.4076, #TF
                65.1986, #RH
                NA, #RS
                8.6085, #TS
                14.7168, #SC
                403.874, #WC
                520.8331, #GC
                NA, #WS
                554 #FD
                )
```
Take a look at the color palette, adjust if desired
```{r, fig.height=1.5, fig.width=7}
linecols <- c('red1', 'gold', 'forestgreen', 'bisque4', 'slateblue4', 'cyan', 
              'aquamarine3', 'magenta2', 'peru','green','yellow','dodgerblue1')
par(mar = c(4,0,0,0))
image(1:length(linecols),.1, as.matrix(1:length(linecols)), col = linecols, yaxt = 'n', ylab = '', xlab = 'catchment', xaxt = 'n')
axis(side = 1, at = 1:length(linecols), labels = siteabbr)
```

### Figure 1 - Plot of all years discharge at First Dam
```{r, echo=F}
i <- 12
site <- sitecodes[i]               #enter site code for file upload and export
sitename <- sitenames[i]        #enter site name for plotting
paste('Site:', sitecodes[i], '-', sitenames[i])
   #the line color vector is used by other plotting scripts as well.  Attempt to keep it consistent
qtc <- read.csv(paste0(mypath,'patched_data/',site,'_patched.csv'), stringsAsFactors = F)
qtc$date <- as.Date(qtc$date,'%Y-%m-%d')
qtc$day <- format(as.Date(qtc$date),'%m-%d')
head(qtc,3)
```

Set viewing parameters and generate a discharge plot
```{r}
xrange <- c(1,366)   #range of water year days to consider

yrange <- c(min(qtc$qpatch, na.rm = T), max(qtc$qpatch, na.rm = T))
#yrange <- c(0,10)  #un-comment to set custom y-axis
pltyears <- seq(min(qtc$WY),max(qtc$WY))
#pltyears <- c(2015,2017,2019)  #un-comment to select custom year range

png(file="fig1c.png",height =3, width = 5, units = 'in', res = 300)
par(mar=c(4,4,2,5))

plot(qtc$wyday[which(qtc$WY==pltyears[1])],qtc$qpatch[which(qtc$WY==pltyears[1])], type = 'n', 
#     xlim = xrange, 
      family = 'A',
      ylim = yrange, 
     xlim = c(125,330),
     xaxt = 'n',
     xlab = '', 
     ylab = '', 
     col = linecols[1],
     main = paste('Discharge of watershed outlet by water year'))
rect(par("usr")[1], par("usr")[3],par("usr")[2], par("usr")[4],col = "gray93")

axis(1, at = dayticks, labels = ticklabs, family = 'A')

legend('topleft', legend = pltyears, lty = 1, col = linecols, lwd = 2, bty = 'n')



for (i in 1:length(pltyears)){
  lines(qtc$wyday[which(qtc$WY==pltyears[i])],qtc$qpatch[which(qtc$WY==pltyears[i])],col = linecols[i], lwd = 2)
}
par(family = 'A', cex = 1.2)
title(ylab = expression(Q~(m^3*"/"*s)),xlab = 'Day of Year', line = 2, cex = 1.2)
dev.off()
```



### Figure 4: timing metrics plotted on discharge/SWIT plot
Generate a dataframe for a selected year, calculate total SWIT for that year

```{r}
i <- 1
site <- sitecodes[i]               #enter site code for file upload and export
sitename <- sitenames[i]        #enter site name for plotting
paste('Site:', sitecodes[i], '-', sitenames[i])
crossdf <- read.csv(paste0('C:/Users/Daniel/Documents/Research/data/dataframes/',site,'_mod.csv'))
paste('date format:', crossdf$date[1])
```
Check the format of the date as printed above and activate the appropriate date formatting line below
```{r}
crossdf$date <- as.Date(crossdf$date,'%Y-%m-%d')
#crossdf$date <- as.Date(crossdf$date,'%m/%d/%Y')
paste('starting date:', crossdf$date[1])
paste('Water years:') 
paste(unique(crossdf$WY))
```
```{r}
wateryear <- 2016 #YYYY format
wydf <- crossdf[which(crossdf$WY==wateryear),]
sum(wydf$SWIT)
year.char <- as.character(wateryear-2000)

```




```{r}
#png(file="fig4a.png",height =4, width = 6.5, units = 'in', res = 300)

par(mar = c(2,4,3,3), family = 'A', cex = 1.2) #(2,4,3,3) left, (2,3,3,4) right
a <- 124 #index to start plot 124
b <- 300 #approx one year after a

barplot(wydf$SWIT[a:b], axes = F, ylim = c(0,1.1*max(wydf$SWIT[a:b], na.rm = T))) 
axis(side = 4, at = pretty(range(wydf$SWIT[a:b]), n = 4),main = 'SWIT')
rect(par("usr")[1], par("usr")[3],par("usr")[2], par("usr")[4],col = "gray93")
barplot(wydf$SWIT[a:b], axes = F, ylim = c(0,1.1*max(wydf$SWIT[a:b], na.rm = T)), add=T) 

par(new=T)
yrange = range(wydf$qpatch[a:b], na.rm = T)
#plot discharge over the window.  The line gets plotted later over the highlight rectangles
plot(wydf$qpatch, xlim = c(a, b), ylim = yrange, type = 'l', 
     ylab = '', 
     col = linecols[i], lwd=2,
     main = paste(sitename,wydf$WY[a]), xaxt = 'n', xlab = ''
     )
axis(1, at = dayticks, labels = ticklabs)


timcolor <- c('green', 'orange','blue')

abline(v = which(wydf$wyday==comp.df[site,paste0(year.char,'_MSD')]), col = timcolor[1])
abline(v = which(wydf$wyday==comp.df[site,paste0(year.char,'_RSD')]), col = timcolor[2])
abline(v = which(wydf$wyday==comp.df[site,paste0(year.char,'_BSD')]), col = timcolor[3])
legend('topleft', lty = 1, col = timcolor[1:2], legend = c('melt start', 'recession start'), bty = 'n')
par(cex = 1.2)
title(ylab = expression(Q~(m^3*"/"*s)), line =2) #comment out for right panels
#mtext('SWIT (mm)', side = 4, line = 2, cex = 1.2) #comment out for left panels

```
### Figure 5: A-normalized and absolute discharge in 2020
--- import, prepare, and filter dataframe for all sites
```{r}
all.sites <-  read.csv('C:/Users/Daniel/Documents/Research/data/dataframes/all_LRO_sites.csv')
all.sites$date <- as.Date(all.sites$date,'%Y-%m-%d')
class(all.sites$date)
colnames(all.sites)
paste(class(all.sites$date), range(all.sites$date))
```
Select water year and variable of interest, restrict dataframe by water year
```{r}
year <- 6 #1-7 for 2015-2021
water.year <- all.years[year]
variable <- "QP"
wy.df <- all.sites[which(all.sites$WY==water.year),]
paste(variable,water.year, year.type[year])
```
identify columns to keep (no user input)
```{r}
sel.codes <- colnames(wy.df)

date.cols <- which(colnames(wy.df) %in% c('date', 'day', 'wyday','WY'))
sel.codes[date.cols]

sel.cols <- which(str_sub(sel.codes,4,5)==variable)
sel.codes[sel.cols]
paste(length(sel.cols), 'sites')
```
Filter dataframe with only selected columns
```{r}
wy.df <- wy.df[c(date.cols,sel.cols)]
date.cols <- NULL
sel.cols <- NULL
head(wy.df,3)
```

--- plot area-Normalized discharge of mainstem sites
```{r}
#use commenting to choose the desired set of sites to plot
choices <- c(1,2,9,10,12) #mainstem

site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```

plot discharge in mm/hr
```{r,fig.height=4, fig.width=6.5, dpi=300}
#png(file="fig5a.png",height =4, width = 7.5, units = 'in', res = 300)
a <- 150
b <- 310

par(mar = c(3,4,3,6), family = 'A', cex = 1.2)
plot(wy.df$FB_QP, xaxt = 'n', 
     xlab = '', 
     ylab = '',
     xlim = c(a,b), ylim = c(0, .16), family = 'A',
     main = '',type = 'n')
rect(par("usr")[1], par("usr")[3],par("usr")[2], par("usr")[4],col = "gray93")


for (i in 1:length(plot.cols)){
  site <- sitecodes[choices[i]]
  bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
  msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
  rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]
  normQ <- wy.df[,plot.cols[i]]*3.6/site.areas[choices[i]]
  lines(normQ[c(bsd:msd)], col = linecols[choices[i]], lty = 2)
  lines(c(rep(NA,msd-bsd),normQ[c(msd:rsd)]), col = linecols[choices[i]],lwd = 2)
  lines(c(rep(NA,rsd-bsd),normQ[c(rsd:365)]), col = linecols[choices[i]],lty = 3)
}

#lines(wy.df$FB_QP*3.6/site.areas[1], col = linecols[1])

legend('right', inset = -0.25, legend = c(site.choices,'bf','melt','rec'), lty = c(rep(1,length(choices)),2,1,3),
       lwd=c(rep(2,length(choices)),1,2,1),col = c(linecols[choices],rep('black',3)), xpd = T,bty = 'n')
title(main = 'Logan River Mainstem Sites' , line = 1)

axis(1, at = dayticks, labels = ticklabs)

title(ylab =  expression(Q[A]~(mm*'/'*hr)) ,xlab = '', line = 2)

```

--- plot area-Normalized discharge of tributaries sites
```{r}
#use commenting to choose the desired set of sites to plot
choices <- c(3,4,5,7,8,12) #tribs & springs

site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```

plot discharge in mm/hr
```{r}
#png(file="fig5b.png",height =4, width = 7.5, units = 'in', res = 300)
a <- 150
b <- 310

par(mar = c(3,4,3,6), family = 'A', cex = 1.2)
plot(wy.df$FB_QP, xaxt = 'n', 
     xlab = '', 
     ylab = '',
     xlim = c(a,b), ylim = c(0, .45), family = 'A',
     main = '',type = 'n')

rect(par("usr")[1], par("usr")[3],par("usr")[2], par("usr")[4],col = "gray93")

axis(1, at = dayticks, labels = ticklabs, family = 'A')
title(main = 'Tributary Catchments', line =1, family = 'A')
for (i in 1:length(plot.cols)){
    site <- sitecodes[choices[i]]
  bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
  msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
  rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]
  normQ <- wy.df[,plot.cols[i]]*3.6/site.areas[choices[i]]
  lines(normQ[c(bsd:msd)], col = linecols[choices[i]], lty = 2)
  lines(c(rep(NA,msd-bsd),normQ[c(msd:rsd)]), col = linecols[choices[i]],lwd = 2)
  lines(c(rep(NA,rsd-bsd),normQ[c(rsd:365)]), col = linecols[choices[i]],lty = 3)
}


legend('right', inset = -0.25, legend = c(site.choices,'bf','melt','rec'), lty = c(rep(1,length(choices)),2,1,3),
       lwd=c(rep(2,length(choices)),1,2,1),col = c(linecols[choices],rep('black',3)), xpd = T,bty = 'n')

par(cex = 1.2)
title(ylab = expression(Q[A]~(mm*'/'*hr)) ,xlab = '', line = 2, family = 'A')

```

--- plot absolute discharge of tributaries & springs
```{r}
#use commenting to choose the desired set of sites to plot
choices <- c(3,4,5,7,8) #tribs & springs

site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```

plot discharge in cms
```{r}
a <- 150
b <- 310

par(mar = c(4,4,3,6), family = 'A')
plot(wy.df$FB_QP, xaxt = 'n', 
     xlab = '', 
     ylab = '',
     xlim = c(a,b), ylim = c(0,2) , family = 'A',
     main = '',type = 'n')
axis(1, at = dayticks, labels = ticklabs, family = 'A')
title(main = 'Tributaries', line =1, family = 'A')
for (i in 1:length(plot.cols)){
    site <- sitecodes[choices[i]]
  bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
  msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
  rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]
  normQ <- wy.df[,plot.cols[i]]
  lines(normQ[c(bsd:msd)], col = linecols[choices[i]], lty = 2)
  lines(c(rep(NA,msd-bsd),normQ[c(msd:rsd)]), col = linecols[choices[i]],lwd = 2)
  lines(c(rep(NA,rsd-bsd),normQ[c(rsd:365)]), col = linecols[choices[i]],lty = 3)
}

legend('right', inset = -0.2, legend = c(site.choices,'bf','melt','rec'), lty = c(rep(1,length(choices)),2,1,3),
       lwd=c(rep(2,length(choices)),1,2,1),col = c(linecols[choices],rep('black',3)), xpd = T,bty = 'n')
par(cex = 1.2)
title(ylab =  expression(Discharge~(m^3*"/"*s)),xlab = 'Day of Year', line = 2, family = 'A')

```

--- plot peak-Normalized discharge of selected sites
```{r}
#use commenting to choose the desired set of sites to plot
choices <- c(1,6,7,11,12) #mainstem & springs
#choices <- c(1,3,4,5,7,8)
#choices <- c(1:12) #all sites

site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```

plot discharge in % of peak
```{r}
#png(file="trial_fig2.png",height =3, width = 5, units = 'in', res = 300)

#a <- 150
#b <- 310

#a <- 200
#b <- 280

par(mar = c(4,4,3,6), family = 'A')
plot(wy.df$FB_QP, xaxt = 'n', 
     xlab = '', 
     ylab = '',
     xlim = c(a,b), ylim = c(0, 1.05), family = 'A',
     main = '',type = 'n')
axis(1, at = dayticks, labels = ticklabs, family = 'A')
title(main = 'Logan Canyon Springs' , line = 1, family = 'A')

for (i in 1:length(plot.cols)){
    site <- sitecodes[choices[i]]
  bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
  msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
  rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]
  normQ <- wy.df[,plot.cols[i]]/max(wy.df[,plot.cols[i]],na.rm = T)
  lines(normQ[c(bsd:msd)], col = linecols[choices[i]], lty = 2)
  lines(c(rep(NA,msd-bsd),normQ[c(msd:rsd)]), col = linecols[choices[i]],lwd = 2)
  lines(c(rep(NA,rsd-bsd),normQ[c(rsd:365)]), col = linecols[choices[i]],lty = 3)
}

#lines(wy.df$FB_QP*3.6/site.areas[1], col = linecols[1])

legend('right', inset = -0.2, legend = c(site.choices,'bf','melt','rec'), lty = c(rep(1,length(choices)),2,1,3),
       lwd=c(rep(2,length(choices)),1,2,1),col = c(linecols[choices],rep('black',3)), xpd = T,bty = 'n')
par(cex = 1.2)
title(ylab = expression(Q[P]~(Fraction~of~annual~maximum)) ,
      xlab = 'Day of Year', line = 2, family = 'A')


```


### Figure 6: Conductance 2019-2021
Iterate through this section for each water year.  Adjust graphical parameters by commenting out lines for x/y axis labels, main titles, and legend

Select water year and variable of interest, restrict dataframe by water year (import all.sites using the figure 4 section)
```{r}
year <- 7 #1-7 for 2015-2021
water.year <- all.years[year]
variable <- "CP"
wy.df <- all.sites[which(all.sites$WY==water.year),]
paste(variable,water.year, year.type[year])
```

identify columns to keep (no user input)
```{r}
sel.codes <- colnames(wy.df)

date.cols <- which(colnames(wy.df) %in% c('date', 'day', 'wyday','WY'))
sel.codes[date.cols]

sel.cols <- which(str_sub(sel.codes,4,5)==variable)
sel.codes[sel.cols]
paste(length(sel.cols), 'sites')
```

Filter dataframe with only selected columns
```{r}
wy.df <- wy.df[c(date.cols,sel.cols)]
date.cols <- NULL
sel.cols <- NULL
head(wy.df,3)
```

--- plot conductance for mainstem & springs
```{r}
choices <- c(1,2,6,9) #mainstem + Ricks Spring
site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```


```{r}
a <- 120
b <- 300

par(mar = c(4,4,1,1), family = 'A')
plot(wy.df[,5], xaxt = 'n', 
     xlab = '', 
     ylab = '',
     xlim = c(a,b), ylim = c(140, 450),
     main = '',type = 'n')
axis(1, at = dayticks, labels = ticklabs)

i <- 1
for (i in 1:length(plot.cols)){
  site <- sitecodes[choices[i]]
bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]

  lines(wy.df[c(bsd:msd),plot.cols[i]], col = linecols[choices[i]], lty = 2)
  lines(c(rep(NA,msd-bsd),wy.df[c(msd:rsd),plot.cols[i]]), col = linecols[choices[i]],lwd = 2)
  lines(c(rep(NA,rsd-bsd),wy.df[c(rsd:365),plot.cols[i]]), col = linecols[choices[i]],lty = 3)

}
#legend('bottom', inset = -0.25, legend = c(site.choices,'bf','melt','rec'), lty = c(rep(1,length(choices)),2,1,3),       lwd=c(rep(2,length(choices)),1,2,1),col = c(linecols[choices],rep('black',3)), xpd = T, bty = 'n', horiz = T)

legend('bottom', inset = -0.25, legend = c(site.choices), lty = c(rep(1,length(choices))),       lwd=c(rep(2,length(choices))),col = c(linecols[choices]), xpd = T, bty = 'n', horiz = T)

par(cex = 1.2)
title(
  ylab =  expression(SpC~(mu*S*"/"*cm)), 
#      xlab = 'Day of Year',  
      line = 2)
#title(main = paste(water.year, year.type[year]), line =1)




```

--- plot conductance for east side tribs
```{r}
choices <- c(3,4,5,7,8) #East side tribs
site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```


```{r}
a <- 120
b <- 300

par(mar = c(4,3,1,1), family = 'A')
plot(wy.df[,5], 
     xaxt = 'n', 
#     yaxt = 'n',
     xlab = '', 
     ylab = '',
     xlim = c(a,b), ylim = c(150, 450),
     main = '',type = 'n')
axis(1, at = dayticks, labels = ticklabs, family = 'A')

i <- 1
for (i in 1:length(plot.cols)){
    site <- sitecodes[choices[i]]

bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]

  lines(wy.df[c(bsd:msd),plot.cols[i]], col = linecols[choices[i]], lty = 2)
  lines(c(rep(NA,msd-bsd),wy.df[c(msd:rsd),plot.cols[i]]), col = linecols[choices[i]],lwd = 2)
  lines(c(rep(NA,rsd-bsd),wy.df[c(rsd:365),plot.cols[i]]), col = linecols[choices[i]],lty = 3)

}

title(
#  ylab =  expression(Specific~Conductance~(mu*S*"/"*cm)),
#  xlab = 'Day of Year',
  line = 2)
#title(main = 'Tributary Catchments - 2020 (Moderate)', line =1)



legend('bottom', inset = -0.25, legend = c(site.choices), lty = c(rep(1,length(choices))), lwd=c(rep(2,length(choices))),col = c(linecols[choices]), xpd = T, bty = 'n', horiz = T)
```
### Figure 7: A&O normalized plots
```{r}
year <- 7 #1-7 for 2015-2021
water.year <- all.years[year]
variable <- "QP"
wy.df <- all.sites[which(all.sites$WY==water.year),]
paste(variable,water.year, year.type[year])
```

identify columns to keep (no user input)
```{r}
sel.codes <- colnames(wy.df)

date.cols <- which(colnames(wy.df) %in% c('date', 'day', 'wyday','WY'))
sel.codes[date.cols]

sel.cols <- which(str_sub(sel.codes,4,5)==variable)
sel.codes[sel.cols]
paste(length(sel.cols), 'sites')
```

Filter dataframe with only selected columns
```{r}
wy.df <- wy.df[c(date.cols,sel.cols)]
date.cols <- NULL
sel.cols <- NULL
head(wy.df,3)
```

```{r}
#use commenting to choose the desired set of sites to plot
choices <- c(1,3,4,5,7,8,12)
site.choices <- siteabbr[choices]

plot.cols <- which(substr(colnames(wy.df),1,2) %in% site.choices)

na.check = rep(NA,length(plot.cols))
for(i in 1:length(plot.cols)){
  na.check[i] <- sum(is.na(wy.df[,plot.cols[i]]))
}

data.frame('sites'=site.choices,'ID' = choices, 'column' = plot.cols, 'NA_count' = na.check)

```

Plot relative to First Dam and delineated by season
```{r}
a <- 120
b <- 300

par(mar = c(3,4,3,1), family = 'A')
plot(wy.df$FB_QP, xaxt = 'n', xlab = '', ylab = '',
     xlim = c(a,b), ylim = c(0, 8),
     main = '',type = 'n')
axis(1, at = dayticks, labels = ticklabs)
title(main = paste(water.year, year.type[year]),line = 1)
i <- 1

for (i in 1:length(plot.cols)){
      site <- sitecodes[choices[i]]

bsd <- comp.df[site,paste0((water.year-2000),'_BSD')]
msd <- comp.df[site,paste0((water.year-2000),'_MSD')]
rsd <- comp.df[site,paste0((water.year-2000),'_RSD')]
normQ <- wy.df[,plot.cols[i]]/site.areas[choices[i]]/(wy.df$FD_QP/site.areas[12])

lines(normQ[c(bsd:msd)], col = linecols[choices[i]], lty = 2)
lines(c(rep(NA,msd-bsd),normQ[c(msd:rsd)]), col = linecols[choices[i]],lwd = 2)
lines(c(rep(NA,rsd-bsd),normQ[c(rsd:365)]), col = linecols[choices[i]],lty = 3)
}

par(cex = 1.2)
title(  ylab = expression(Q[N]~(Ratio~to~outlet)), line = 2)


#legend('right', inset = -0.2, legend = c(site.choices,'bf','melt','rec'), lty = c(rep(1,length(choices)),2,1,3),
#       lwd=c(rep(2,length(choices)),1,2,1),col = c(linecols[choices],rep('black',3)), xpd = T, bty = 'n')
``` 
### Figure 8: Response metrics by catchment attributes
```{r}
sites <- 1:12 #select all sites
sites <- which(!is.na(site.areas)) #select surface catchments
sites <- c(4,5,7,8) 
#sites <-  c(1,2,3,4,5,7,8,9,10,12) #select custom 
sites <- c(1,2,3,9,10,12) #exclude E side tribs
years <- c(1:7) #numbers 1-7 for '15-'21
funct <- 'QRM'
y.title <- 'baseflow'
y.units <- 'cms'
ylab <- expression(Average~Annual~Q[A]~(mm/hr)) #use this version to 
catch.var <- 1
x.var <- paste0('CV_',comp.vars[catch.var,1])
x.title <- comp.vars[catch.var,2]
plot.title <- paste('Median', y.title,'by',comp.vars[catch.var,3])

sel.sites <-   sitecodes[sites]

sel.cols <- paste0(acf.years[years],'_',funct)

new.comp <- comp.df[sel.sites,c(x.var,sel.cols)]
new.comp
check <- 1
normed <- ''
```

normalize by area (cms to mm/hr) if appropriate
```{r}
runblock <- seq(1:check)
for (y in sel.cols)
new.comp[,y] <- new.comp[,y]/site.areas[sites]*3.6
check <- NA
y.units <- '(mm/hr)'
normed <- 'Normalized'
```

```{r}
ylab <- paste(y.title,y.units) #comment out to use expression version

pt.types <- plot.points[years]
par(mar = c(3,4,3,1), family = 'A')
plot(new.comp[,sel.cols[1]]~new.comp[,x.var], 
#     xaxt = 'n', #remove x-axis for aspect plots
     ylim = range(new.comp[,sel.cols], na.rm = T) ,
     main = '',xlab = '', ylab = '', 
     type = 'n')
title(main = paste(normed,plot.title), line = 1)

#axis(1, at = c(150,180, 225, 270,300), labels = c('SSE','S','SW','W','WNW')) #axis for aspect

for (x in 1:length(sel.cols)){
  points(new.comp[,sel.cols[x]]~new.comp[,x.var], col = linecols[sites], pch = pt.types[x])

}
par(cex = 1.2)

title(
  xlab = x.title,
  ylab = ylab,
  line = 2)
#legend('bottom', inset = -0.6, legend = siteabbr[sites], pch = 19, col = linecols[sites], xpd = T, bty = 'n', horiz = T)
#legend('bottom', inset = -0.8, legend = c(paste0('20',acf.years[years])), pch = c(pt.types), col =  'black', xpd = T, bty = 'n', horiz = T)
```
Plot for aspect w/ directions
```{r}

pt.types <- plot.points[years]
par(mar = c(3,4,3,1), family = 'A')
plot(new.comp[,sel.cols[1]]~new.comp[,x.var], ylim = range(new.comp[,sel.cols], na.rm = T) ,
     main = paste(normed,plot.title),xlab = '', ylab = '', type = 'n', xaxt = 'n')

for (x in 1:length(sel.cols)){
  points(new.comp[,sel.cols[x]]~new.comp[,x.var], col = linecols[sites], pch = pt.types[x])

}
#legend('right', inset = -0.2, legend = c(siteabbr[sites],paste0('20',acf.years[years])), pch = c(rep(19, times = length(sites)),pt.types), col = c(linecols[sites], rep('black', times = length(years))), xpd = T)
par(cex = 1.2)
title(
  xlab = x.title,
  ylab = ylab,
  line = 2)
axis(1, at = c(150,180, 225, 270,300), labels = c('SSE','S','SW','W','WNW'))

```

### Figure 9: Response metrics by prior conditions
--- Scatterplots of relationships stratified by site and year
Reference metric codes from metrics.rmd script or Workflow/methods )1 google doc:
https://docs.google.com/document/d/1yl3RUMSXCiZtCC0L2mRWoC49Toi6UPyVNRMVbOieKPg/edit
Create dataframes of the independent and dependent variables to look at
```{r}
sites <- 1:12 #select all sites
#sites <- c(1:6,8:12) #exclude Sawmill
sites <- which(!is.na(site.areas)) #select surface catchments
sites <- c(1:5,12) #sites w/ UEB modeled data
years <- c(1:4) #numbers 1-7 for '15-'21
funct <- 'RRM'
y.title <- 'Recession Rate'
y.units <- '(mm/hr/day)'

comp.var <- 2
x.var <- paste0(prior.vars[comp.var,1])
x.title <- prior.vars[comp.var,2]
plot.title <- paste('First Month Recession Slope','by',prior.vars[comp.var,3])
#x.var <- 'MXS'
#x.title <- 'Maximum Snow-Water Equivalent'
#x.units <- ''


sel.sites <-   sitecodes[sites]

y.cols <- paste0(acf.years[years],'_',funct)
x.cols <- paste0(acf.years[years],'_',x.var)
y.df <- comp.df[sel.sites,y.cols]
x.df <- comp.df[sel.sites,x.cols]

x.df
y.df
sum(is.na(x.df)-is.na(y.df))==0 #checks that both dataframes have NAs in the same places
plot.title
check <- 1 #sets up the safety to prevent double-normalization
y.normed <- ''
x.normed <- ''
```
Normalize Y values by area (for flow-unit responses)
```{r}
runblock <- c(1:check)
for (myrow in 1:nrow(y.df))
y.df[myrow,] <- y.df[myrow,]/site.areas[sites[myrow]]*3.6
check <- NULL
y.df
#y.units <- '(mm/hr)'
y.normed <- 'Normalized'
```

Normalize X values by area (for flow-unit conditions)
```{r}
runblock <- c(1:check)
for (myrow in 1:nrow(x.df))
x.df[myrow,] <- x.df[myrow,]/site.areas[sites[myrow]]*3.6
check <- NULL
x.df
x.units <- '(mm/hr)'
x.normed <- 'Normalized'
```



Generate plot
```{r}
ii <- 1
site <- sitecodes[ii]
site.in <- as.numeric(x.df[site,])
site.out <- as.numeric(y.df[site,])
pt.types <- plot.points[years]


par(mar = c(4,4,4,6), family = 'A')

plot(site.out~site.in, type = 'n', xlab = '', ylab = '',
     main = paste(y.normed,plot.title), 
     ylim = range(y.df, na.rm = T), xlim = range(x.df, na.rm =T ))

for (ii in sites) {
site <- sitecodes[ii]
site.in <- as.numeric(x.df[site,])
site.out <- as.numeric(y.df[site,])  
  
points(site.out~site.in, col = linecols[ii], pch = plot.points[1:length(years)])
}

legend('right', inset = -0.2, legend = c(siteabbr[sites],paste0('20',acf.years[years])), pch = c(rep(19, times = length(sites)),pt.types), col = c(linecols[sites], rep('black', times = length(years))), xpd = T, bty = 'n')
par(cex = 1.2)
title(xlab = paste(x.title), ylab = paste(y.title,y.units), line = 2)
```


--- Evaluate and plot linear models for each
Franklin Basin LM
```{r}
fb.lm <- lm(as.numeric(y.df[1,])~as.numeric(x.df[1,]))

tg.lm <- lm(as.numeric(y.df[2,])~as.numeric(x.df[2,]))

bc.lm <- lm(as.numeric(y.df[3,])~as.numeric(x.df[3,]))

tf.lm <- lm(as.numeric(y.df[4,])~as.numeric(x.df[4,]))

rh.lm <- lm(as.numeric(y.df[5,])~as.numeric(x.df[5,]))

fd.row <- which(row.names(x.df)=='LR_FD')
fd.lm <- lm(as.numeric(y.df[fd.row,])~as.numeric(x.df[fd.row,]))

all.lm <- lm(stack(y.df)$values~stack(x.df)$values)
#summary(all.lm)
```

plot points of only one site
```{r}
plot(as.numeric(y.df[3,])~as.numeric(x.df[3,]))
abline(bc.lm)
```

generate plot of all points with linear models for each site
```{r}
ii <- 1
site <- sitecodes[ii]
site.in <- as.numeric(x.df[site,])
site.out <- as.numeric(y.df[site,])
pt.types <- plot.points[years]


par(mar = c(4,4,3,1), family = 'A')
plot(site.out~site.in, type = 'n', 
     xlab = '', ylab = '', 
     main = '',
     ylim = range(y.df, na.rm = T), xlim = range(x.df, na.rm =T ))
title(main = paste(y.normed,plot.title),font = 2)

for (ii in sites) {
site <- sitecodes[ii]
site.in <- as.numeric(x.df[site,])
site.out <- as.numeric(y.df[site,])  
  
points(site.out~site.in, col = linecols[ii], pch = plot.points[1:4])
}
abline(fb.lm, col = linecols[1])
abline(tg.lm, col = linecols[2])
abline(bc.lm, col = linecols[3])
abline(tf.lm, col = linecols[4])
abline(rh.lm, col = linecols[5])
abline(fd.lm, col = linecols[12])

#legend('bottom', inset = -0.45, legend = c(siteabbr[sites],paste0('20',acf.years[years])), pch = c(rep(19, times = length(sites)),pt.types), col = c(linecols[sites], rep('black', times = length(years))), xpd = T, bty = 'n', horiz = T)
par(cex = 1.2)
title(xlab = paste(x.title), ylab = paste(y.title,y.units), line = 2)
```

---


### Figure 10: Correlograms
---Autocorrelograms for top two panels
```{r}
#enter the 
site.nums <- c(1:5,6,7,8,9,11,12)
site.nums <- c(1:12)
sites <- siteabbr[site.nums] #enter the 2-letter codes for the sites you want to compare
years <- 3
years <- acf.years[years]
season <- c('F') #F-full, M-Melt, B-baseflow
variable <- c('Q') #Q-discharge, C-conductance, P-C|Q, M-Q|SWI(SNOTEL)
funct <- c('A') #A-ACF, C-Cross|SWIT, S-Cross|SNOTEL melt

sel.codes <- colnames(corr.df)

#filter by site
sel.cols <- which(str_sub(sel.codes,1,2) %in% sites) 
sel.codes <- sel.codes[sel.cols]

#filter by year
sel.cols <- which(str_sub(sel.codes,4,5) %in% years) 
sel.codes <- sel.codes[sel.cols]

#filter by season
sel.cols <- which(str_sub(sel.codes,7,7) %in% season) 
sel.codes <- sel.codes[sel.cols]

#filter by variable
sel.cols <- which(str_sub(sel.codes,9,9) %in% variable) 
sel.codes <- sel.codes[sel.cols]

#filter by function
sel.cols <- which(str_sub(sel.codes,11,11) %in% funct) 
sel.codes <- sel.codes[sel.cols]

sel.codes
```


```{r}
c.comp.df <- corr.df[c('lag',sel.codes)]
head(c.comp.df)
```

Generate plot label string
```{r}
lab <- paste0("Q Autocorrelation for 20",years[1])
lab
(colnames(c.comp.df)[-1])
```

```{r}
#set line parameters
lncolors <- c(1,2,3,4) #number based on site
#lncolors <- site.nums
#Referencing the output above, enter site codes of each column in order how they'll appear in the legend
ln.names <- c('FB' 
              ,'TG'
              ,'BC'
#              ,'TS'
#              ,'SC'
#              ,'WC'
#              ,'GC'
              ,'TF'
#              ,'RH'
#              ,'FD'
#              ,'FB - melt' 
 #             ,'TG - melt'
  #            ,'BC - melt'
   #           ,'TF - melt'
    #          ,'RH - melt'
)

#Create a blank plot
par(mar = c(3.5,3.5,2,2), family = 'A')
plot(c.comp.df$lag, c.comp.df$acf, col=linecols[1],
     ylab = '', xlab = '', ylim = c(0.1,1), xlim = c(0,50), 
     main = '',
     type = 'n', #change to 'n' to hide, 'l' to show
     )
par(cex = 1.2, font = 2)
title(
  ylab = 'Correlation',
  xlab = 'Lag (days)',
  line = 2.2)
title(main = lab, line = 1)
#Draw all lines on the plot
for(i in c(2:ncol(c.comp.df))){
  lines(c.comp.df[i], col = linecols[lncolors[i-1]],lty=1)
}

abline(h = 0.2, lty = 3)

par(cex = 1, font = 1)
#legend('topright', legend = ln.names, lty = 1, col = linecols[lncolors], lwd = 2, bty = 'n') 
#legend('topright', legend = c('FB','TG','BC','TF','RH','TS','SC','WC','GC','FD'), lty = 1, col = linecols[c(1,2,3,4,5,7,8,9,10,12)], lwd = 2, bty = 'n') 
```

--- TF ACF by water year
```{r}
#enter the 
site.nums <- 4
sites <- siteabbr[site.nums] #enter the 2-letter codes for the sites you want to compare
years <- c(2:7)
years <- acf.years[years]
season <- c('F') #F-full, M-Melt, B-baseflow
variable <- c('Q') #Q-discharge, C-conductance, P-C|Q, M-Q|SWI(SNOTEL)
funct <- c('A') #A-ACF, C-Cross|SWIT, S-Cross|SNOTEL melt

sel.codes <- colnames(corr.df)

#filter by site
sel.cols <- which(str_sub(sel.codes,1,2) %in% sites) 
sel.codes <- sel.codes[sel.cols]

#filter by year
sel.cols <- which(str_sub(sel.codes,4,5) %in% years) 
sel.codes <- sel.codes[sel.cols]

#filter by season
sel.cols <- which(str_sub(sel.codes,7,7) %in% season) 
sel.codes <- sel.codes[sel.cols]

#filter by variable
sel.cols <- which(str_sub(sel.codes,9,9) %in% variable) 
sel.codes <- sel.codes[sel.cols]

#filter by function
sel.cols <- which(str_sub(sel.codes,11,11) %in% funct) 
sel.codes <- sel.codes[sel.cols]

sel.codes
```


```{r}
c.comp.df <- corr.df[c('lag',sel.codes)]
head(c.comp.df)
```

Generate plot label string
```{r}
lab <- paste0("Q Autocorrelation for Temple Fork")
lab
(colnames(c.comp.df)[-1])
```

```{r}
#set line parameters
lncolors <- c(1:6) #number based on site
#lncolors <- site.nums
linetypes <- c(1,1,1,1,1,1) #1 for runoff, 2 for melt


#Create a blank plot
par(family = 'A')
plot(c.comp.df$lag, c.comp.df$acf, col=linecols[1],
     ylab = '', xlab = '', ylim = c(0.1,1), xlim = c(0,50), 
     main = '',
     type = 'n', #change to 'n' to hide, 'l' to show
     )
par(cex = 1.5, font = 2)
title(
  ylab = 'Correlation',
  xlab = 'Lag (days)',
  line = 2.2)
title(main = lab, line = 1)
#Draw all lines on the plot
for(i in c(2:ncol(c.comp.df))){
  lines(c.comp.df[i], col = linecols[lncolors[i-1]],lty=linetypes[i-1])
}

abline(h = 0.2, lty = 3)

par(cex = 1, font = 1)
legend('topright', legend = c(2016:2021), lty = linetypes, col = linecols[c(4,5,6,1,2,3)], lwd = 2, bty = 'n') 
```







---Cross correlograms for the lower panels (2016-2018)
```{r}
#enter the 
site.nums <- c(1:5,7,8,9,12)
sites <- siteabbr[site.nums] #enter the 2-letter codes for the sites you want to compare
years <- 4
years <- acf.years[years]
season <- c('F','M') #F-full, M-Melt, B-baseflow
variable <- c('Q') #Q-discharge, C-conductance, P-C|Q, M-Q|SWI(SNOTEL)
funct <- c('C') #A-ACF, C-Cross|SWIT, S-Cross|SNOTEL melt

sel.codes <- colnames(corr.df)

#filter by site
sel.cols <- which(str_sub(sel.codes,1,2) %in% sites) 
sel.codes <- sel.codes[sel.cols]

#filter by year
sel.cols <- which(str_sub(sel.codes,4,5) %in% years) 
sel.codes <- sel.codes[sel.cols]

#filter by season
sel.cols <- which(str_sub(sel.codes,7,7) %in% season) 
sel.codes <- sel.codes[sel.cols]

#filter by variable
sel.cols <- which(str_sub(sel.codes,9,9) %in% variable) 
sel.codes <- sel.codes[sel.cols]

#filter by function
sel.cols <- which(str_sub(sel.codes,11,11) %in% funct) 
sel.codes <- sel.codes[sel.cols]

sel.codes
```


```{r}
c.comp.df <- corr.df[c('lag',sel.codes)]
head(c.comp.df)
```

Generate plot label string
```{r}
lab <- paste0("Q|SWIT Cross-correlation for 20",years[1])
lab
(colnames(c.comp.df)[-1])
```

```{r}
#set line parameters
lncolors <- c(1,2,3,4,5,1,2,3,4,5) #number based on site
linetypes <- c(1,1,1,1,1,2,2,2,2,2) #1 for runoff, 2 for melt
ln.names <- c('FB', 
              'TG',
              'BC',
              'TF',
              'RH',
#              'TS',
#              'SC',
#              'WC'
              'FB - melt', 
              'TG - melt',
            'BC - melt',
             'TF - melt',
            'RH - melt'
)

#Create a blank plot
par(family = 'A')
plot(c.comp.df$lag, c.comp.df$acf, col=linecols[1],
      ylim = c(0.1,1), xlim = c(0,50), 
     main = '',ylab = '', xlab = '',
     type = 'n', #change to 'n' to hide, 'l' to show
     )
#Draw all lines on the plot
for(i in c(2:ncol(c.comp.df))){
  lines(c.comp.df[i], col = linecols[lncolors[i-1]],lty=linetypes[i-1])
}
par(font = 2, cex = 1.5)
title(
  xlab = 'Lag (days)',
#  ylab = 'Correlation',
  line = 2.2)
title(main = lab, line = 1)
abline(h = 0.2, lty = 3)

#legend('topright', legend = ln.names, lty = linetypes, col = linecols[lncolors], bty = 'n') 
#legend('topright', legend = c(ln.names[1:5], 'Runoff', 'Melt'),lwd = 2, lty = c(1,1,1,1,1,1,2), col = c(linecols[1:5],'black','black'), bty = 'n')
```



```{r}
comp.names <- sitenames[sites]
#identify sites to compare
comp.sites <- acf.sites[sites] 
#FB_, TG_, BC_, TF_, RH_, RS_, TS_, SC_, WC_, GC_, SS_, SD_

#If years are absent, manage that by commenting out operations later
acf.year <- '18' #choose year for comparison 
acf.season <- '_F' #_F, _W, _B - set season code (runoff, wet, baseflow)
acf.variable <- '_C' #_Q, _C - set discharge/conductance variable
acf.function <- "_A" #_A, _C, _S - set ACF, CCF(UEB), or CCF(SNOTEL) function
acf.codes <- paste0(comp.sites, acf.year, acf.season, acf.variable, acf.function)
acf.codes
plot.type <- 'C Autocorrelation'
```
```{r}
plot(corr.df$lag, corr.df[,acf.codes[1]],
     ylab = 'Correlation', xlab = 'Lag (days)', ylim = c(-0.2,0.99), xlim = c(0,50), 
     main = paste0(plot.type, ' for water year 20', acf.year), #write title each time!
     type = 'n', #change to 'n' to hide, 'l' to show
     )

for (i in 1:length(sites)) {
  
#for SC cross correlations, add a negative sign before the vector call
lines(corr.df[acf.codes[i]], col = linecols[sites[i]],xlim = c(0,50))
}

abline(h = 0.2, lty = 3)
abline(h = -0.2, lty = 3)

legend('bottomleft', legend = sitenames[sites], lty = 1, col = linecols[sites])
```

---

### SI plot showing outsized recession from 2017 carry over into 2018
```{r}
xrange <- c(1,366)   #range of water year days to consider
dayticks <- 11 #number of tick marks on x axis
yrange <- c(min(qtc$qpatch, na.rm = T), max(qtc$qpatch, na.rm = T))
yrange <- c(2,10)  #un-comment to set custom y-axis
pltyears <- seq(min(qtc$WY),max(qtc$WY))
pltyears <- c(2015,2016,2017,2018,2019)  #un-comment to select custom year range

wylabels <- wydates$day[seq(xrange[1],xrange[2],length.out = dayticks)]
plot(qtc$qpatch[which(qtc$WY==pltyears[1])], type = 'l',
#plot(qtc$wyday[which(qtc$WY==pltyears[1])],qtc$qpatch[which(qtc$WY==pltyears[1])], type = 'l', 
#     xlim = xrange, 
      ylim = yrange,
     xlim = c(1,122),
     xaxt = 'n',
     xlab = 'Day of Year', ylab = 'Discharge (cms)', col = linecols[1],
     main = paste('Discharge of ', sitename, ' by water year'))
axis(1, at = seq(xrange[1],xrange[2],length.out = dayticks), labels = wylabels)
for (i in 2:length(pltyears)){
  lines(qtc$qpatch[which(qtc$WY==pltyears[i])],col = linecols[i])
}
legend('topleft', legend = pltyears, lty = 1, col = linecols)

```

 
 
### SI hypsometric curves
--- import rasters and compile all.hyps dataframe
```{r}
i <- 12
site <- sitecodes[i]               #enter site code for file upload and export
sitename <- sitenames[i]        #enter site name for plotting
siteabv <- siteabbr[i]
paste('Site:', site, '-', sitename,'(',siteabv,')')
   #the line color vector is used by other plotting scripts as well.  Attempt to keep it consistent
```


```{r}
inraster <- raster(paste0('C:/Users/Daniel/Documents/Research/hypsometric_curves/',siteabv,'_DEM.tif'))
elevFreq <- freq(inraster)
```

```{r}
head(elevFreq,3)
tail(elevFreq,3)

```
Create a dataframe with frequencies of all elevation values and cumulative sums
```{r}
truelev <- data.frame(elevFreq[c(1:(nrow(elevFreq)-1)),]) #ignores last row with NA values
#truelev <- data.frame(elevFreq[-c(1,2),]) #use this to remove any rows
for (i in seq(1,nrow(truelev))){
  truelev$sum[i] <- sum(truelev$count[1:i])
}

truelev$CDVal <- truelev$sum/sum(truelev$count)
tail(truelev,2) #last two lines should approach and equal 1 for CDVal
```
```{r}
site.df <- data.frame('elev' = truelev$value, siteabv = truelev$CDVal)
colnames(site.df)[2] <- siteabv
head(site.df,3)
tail(site.df,3)
```
```{r}
all.hyps <- merge(all.hyps, site.df, by = 'elev', all = T)
```

```{r}
write.csv(all.hyps, 'C:/Users/Daniel/Documents/Research/data/dataframes/hypsometry.csv', row.names = F)
```

--- open an use the hypsometry.csv file as all.hyps dataframe
```{r}
all.hyps <- read.csv('C:/Users/Daniel/Documents/Research/data/dataframes/hypsometry.csv')
head(all.hyps)
```

```{r}
plot(all.hyps$FB, type = 'n', 
     ylab = '', xlab = '', col = linecols[1], xaxt = 'n', family = 'A')

xlabrows <- c(76,576,1076,1576)
axis(1, at = xlabrows, labels = all.hyps$elev[xlabrows], family = 'A')
title(family = 'A', xlab = 'Elevation (m)', main = 'Subcatchment Hypsometric Curves', ylab ='Fraction of Subcatchment Below')

choices <- c(1,2,3,4,5,7,8,9,10,12)
for (i in choices){
  lines(all.hyps[,siteabbr[i]], col = linecols[i], lwd = 2)
}
legend('right', col = linecols[choices], legend = siteabbr[choices], bty = 'n', lty =1, lwd = 2)
```
--- Archetype hydrographs
```{r}
outlet <- c(1,1,1,1.1,1.2,1.4)
plot(outlet, type = 'l', xaxt = 'n', yaxt = 'n', col = linecols[12], )
```


---
###